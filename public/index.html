<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Pastebin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #0f172a;
      --bg-soft: #1e293b;
      --border: #334155;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --success: #22c55e;
      --danger: #f97373;
      --text-primary: #f1f5f9;
      --text-muted: #94a3b8;
      --text-soft: #64748b;
      --shadow: 0 20px 40px rgba(0,0,0,0.5);
      --radius-lg: 1.1rem;
      --radius-pill: 999px;
    }
    :root[data-theme="light"] {
      --bg: #f8fafc;
      --bg-elevated: #ffffff;
      --bg-soft: #f1f5f9;
      --border: #e2e8f0;
      --accent: #0ea5e9;
      --accent-soft: rgba(14,165,233,0.12);
      --success: #16a34a;
      --danger: #ef4444;
      --text-primary: #0f172a;
      --text-muted: #64748b;
      --text-soft: #94a3b8;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    :root[data-theme="terminal"] {
      --bg: #000000;
      --bg-elevated: #020617;
      --bg-soft: #020617;
      --border: #064e3b;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.16);
      --success: #22c55e;
      --danger: #f97373;
      --text-primary: #ecfdf5;
      --text-muted: #6ee7b7;
      --text-soft: #4ade80;
      --shadow: 0 20px 40px rgba(0,0,0,0.8);
    }
    :root[data-theme="terminal"] pre,
    :root[data-theme="terminal"] textarea#pasteInput {
      background:#020617;
      color:#a7f3d0;
    }
    :root[data-theme="terminal"] a {
      color:#4ade80;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family:system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text-primary);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      padding:1.5rem 2rem;
      border-bottom:1px solid var(--border);
      background:var(--bg-elevated);
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      position:sticky;
      top:0;
      z-index:10;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:0.8rem;
      font-weight:600;
      font-size:1.1rem;
    }

    .brand-logo {
      width:40px;
      height:40px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, var(--accent), #1e293b);
      color:white;
      display:grid;
      place-items:center;
      font-weight:900;
      box-shadow:0 0 0 2px rgba(56,189,248,.4);
    }

    .header-actions {
      display:flex;
      gap:1rem;
      align-items:center;
      flex-wrap:wrap;
    }

    .container {
      max-width:1100px;
      margin:0 auto;
      padding:2rem;
      flex:1 0 auto;
    }

    .card {
      background:var(--bg-elevated);
      border-radius:var(--radius-lg);
      padding:2rem;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }

    .btn {
      background:var(--accent);
      color:white;
      border:none;
      padding:.7rem 1.4rem;
      border-radius:var(--radius-pill);
      cursor:pointer;
      font-weight:600;
      box-shadow:0 8px 25px rgba(56,189,248,0.3);
      transition:all .2s;
      white-space:nowrap;
      font-size:0.95rem;
    }
    .btn:hover { transform:translateY(-2px); }
    .btn-outline {
      background:transparent;
      color:var(--text-muted);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn-success { background:var(--success); }

    .btn-sm {
      padding:0.3rem 0.7rem;
      font-size:0.8rem;
      box-shadow:none;
    }
    .btn-danger {
      border-color:var(--danger);
      color:var(--danger);
      background:transparent;
    }
    .btn-danger:hover {
      background:rgba(248,113,113,0.1);
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:1.5rem;
    }
    th, td {
      padding:1rem;
      text-align:left;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    th { background:var(--bg-soft); }
    tr:hover { background:var(--bg-soft); }

    pre {
      background:#0f172a;
      color:#e2e8f0;
      padding:1.5rem;
      border-radius:1rem;
      overflow-x:auto;
      white-space:pre-wrap;
      font-family:ui-monospace,monospace;
    }
    :root[data-theme="light"] pre {
      background:#f8fafc;
      color:#0f172a;
    }

    .never { color:var(--success); font-weight:600; }
    .empty { text-align:center; padding:5rem 0; color:var(--text-muted); font-size:1.3rem; }

    .mode-toggle-row {
      display:flex;
      justify-content:center;
      gap:1rem;
      margin-bottom:2rem;
      flex-wrap:wrap;
    }

    .mode-toggle-row .btn {
      background:var(--bg-soft);
      border:1px solid var(--border);
      color:var(--text-muted);
      box-shadow:none;
    }
    .mode-toggle-row .btn.active {
      background:var(--accent);
      color:#ffffff;
      border-color:var(--accent);
      box-shadow:0 8px 25px rgba(56,189,248,0.3);
    }

    .expiry-row {
      display:flex;
      justify-content:center;
      gap:0.8rem;
      flex-wrap:wrap;
      margin-bottom:2.5rem;
    }

    .expiry-btn {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      padding: 0.45rem 1rem;
      font-size: 0.9rem;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background .15s, color .15s, border-color .15s, transform .1s;
    }
    .expiry-btn:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
    }
    .expiry-btn.active {
      background: var(--success);
      color: #ffffff;
      border-color: var(--success);
    }

    .auth-row {
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      margin-bottom:1.5rem;
    }
    .auth-fields {
      display:flex;
      flex-wrap:wrap;
      gap:0.6rem;
      align-items:center;
    }
    .auth-fields input {
      padding:0.55rem 0.75rem;
      border-radius:0.75rem;
      border:1px solid var(--border);
      background:var(--bg-soft);
      color:var(--text-primary);
      min-width:0;
      flex:1 1 150px;
    }
    .auth-meta {
      font-size:0.85rem;
      color:var(--text-muted);
    }
    .auth-status {
      font-size:0.85rem;
      min-height:1.2em;
    }
    .auth-status.error {
      color:#f97373;
    }
    .auth-status.ok {
      color:var(--success);
    }

    .logged-in-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.5rem;
      margin-bottom:1.5rem;
    }

    footer {
      text-align:center;
      padding:1.5rem 0;
      color:var(--text-muted);
      font-size:0.85rem;
      border-top:1px solid var(--border);
      margin-top:2rem;
      flex-shrink:0;
    }

    .pill {
      display:inline-block;
      padding:0.2rem 0.6rem;
      border-radius:999px;
      font-size:0.75rem;
      border:1px solid var(--border);
      color:var(--text-muted);
    }

    .pill-admin { border-color:var(--accent); color:var(--accent); }
    .pill-mod { border-color:var(--success); color:var(--success); }
    .pill-banned { border-color:var(--danger); color:var(--danger); }

    @media (max-width: 768px) {
      header {
        padding:1rem 1.25rem;
        flex-direction:column;
        align-items:flex-start;
        gap:0.75rem;
      }

      .container {
        padding:1.25rem 1rem;
      }

      .card {
        padding:1.5rem 1.25rem;
      }

      .brand-logo {
        width:32px;
        height:32px;
        font-size:0.9rem;
      }

      .header-actions {
        width:100%;
        justify-content:flex-start;
        gap:0.75rem;
      }

      .header-actions .btn {
        padding:.55rem 1.1rem;
        font-size:0.9rem;
      }

      .mode-toggle-row {
        gap:0.6rem;
      }
      .mode-toggle-row .btn {
        flex:1 1 45%;
        text-align:center;
      }

      .expiry-row {
        gap:0.5rem;
      }
      .expiry-btn {
        flex:1 1 45%;
        text-align:center;
        font-size:0.85rem;
        padding:0.4rem 0.75rem;
      }

      #fileDropzone {
        padding:2.5rem 1.5rem !important;
      }
      #fileDropzone div:first-child {
        font-size:1.4rem !important;
      }

      #pasteInput {
        min-height:200px !important;
        font-size:0.95rem !important;
      }

      table {
        display:block;
        width:100%;
        overflow-x:auto;
        white-space:nowrap;
      }
      th, td {
        padding:0.75rem 0.5rem;
        font-size:0.9rem;
      }

      .auth-fields {
        flex-direction:column;
        align-items:stretch;
      }
      .auth-fields input {
        width:100%;
      }
      .auth-fields .btn {
        width:100%;
        justify-content:center;
        text-align:center;
      }
    }
  </style>
</head>
<body>

  <!-- VIEW PAGE (dashboard or admin) -->
  <div id="view" style="display:none">
    <header>
      <div class="brand">
        <div class="brand-logo">P</div>
        <div>Pastebin</div>
      </div>
      <div class="header-actions">
        <a href="/" class="btn btn-outline">Home</a>
        <button class="btn btn-outline theme-toggle" data-theme-toggle>
          <span class="theme-icon">Moon</span> <span class="theme-label">Dark</span>
        </button>
      </div>
    </header>
    <div class="container">
      <div class="card">
        <h1 id="vtitle"></h1>
        <div style="color:var(--text-muted);margin:1rem 0" id="vmeta"></div>
        <div id="vcontent"></div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app">
    <header>
      <div class="brand">
        <div class="brand-logo">P</div>
        <div>
          <div style="font-weight:600;font-size:1.2rem">Pastebin</div>
          <div style="font-size:0.85rem;color:var(--text-muted)">Instant • Private • Forever</div>
        </div>
      </div>
      <div class="header-actions">
        <button id="openDashboard" class="btn btn-success">My Shares</button>
        <button id="openAdmin" class="btn btn-outline" style="display:none;">Admin</button>
        <button class="btn btn-outline theme-toggle" data-theme-toggle>
          <span class="theme-icon">Moon</span> <span class="theme-label">Dark</span>
        </button>
      </div>
    </header>

    <div class="container">
      <div class="card" style="max-width:800px;margin:auto">
        <h1 style="text-align:center;margin-bottom:2rem">Share anything in seconds</h1>

        <!-- AUTH SECTION -->
        <div id="authSection">
          <div id="loggedOutView" class="auth-row">
            <div class="auth-meta">
              Create an account or log in. Your files and pastes will be tied to your account and only visible in your own dashboard.
            </div>
            <div class="auth-fields">
              <input id="authEmail" type="email" placeholder="Email" autocomplete="email">
              <input id="authPassword" type="password" placeholder="Password (min 6 chars)" autocomplete="current-password">
              <button id="loginBtn" class="btn btn-success">Log in</button>
              <button id="registerBtn" class="btn btn-outline">Register</button>
            </div>
            <div id="authStatus" class="auth-status"></div>
          </div>

          <div id="loggedInView" class="logged-in-row" style="display:none">
            <div>
              <div style="font-size:0.9rem;color:var(--text-muted)">Logged in as</div>
              <div id="userLabel" style="font-size:0.95rem;font-weight:600"></div>
            </div>
            <button id="logoutBtn" class="btn btn-outline">Log out</button>
          </div>
        </div>

        <!-- MAIN SHARE UI (hidden until logged in) -->
        <div id="mainContent" style="display:none">
          <div class="mode-toggle-row">
            <button id="modeFilesBtn" class="btn active">Files</button>
            <button id="modePasteBtn" class="btn btn-outline">Paste</button>
          </div>

          <div class="expiry-row">
            <button class="expiry-btn" data-expiry="1h">1 hour</button>
            <button class="expiry-btn active" data-expiry="1d">1 day</button>
            <button class="expiry-btn" data-expiry="7d">7 days</button>
            <button class="expiry-btn" data-expiry="30d">30 days</button>
            <button class="expiry-btn" data-expiry="never">Never expires</button>
          </div>

          <div id="fileDropzone" style="border:2px dashed var(--border);padding:4rem;border-radius:1.4rem;text-align:center;cursor:pointer;transition:.2s">
            <div style="font-size:2rem;margin-bottom:1rem">Drop files anywhere</div>
            <div style="color:var(--text-muted);margin-bottom:2rem">or</div>
            <button id="browseBtn" class="btn" style="font-size:1.1rem;padding:.9rem 2rem">Choose files</button>
            <input id="fileInput" type="file" multiple style="display:none">
          </div>

          <div id="pasteContainer" style="display:none">
            <textarea id="pasteInput" placeholder="Paste code, logs, text — it’s saved forever on this server…" style="width:100%;min-height:260px;padding:1.4rem;border-radius:1rem;border:1px solid var(--border);background:var(--bg-soft);color:var(--text-primary);font-family:ui-monospace,monospace;font-size:1.02rem"></textarea>
            <div style="text-align:right;margin-top:1.2rem">
              <button id="pasteSubmitBtn" class="btn" style="padding:.8rem 2rem;font-size:1.1rem">Share paste</button>
            </div>
          </div>

          <div id="status" style="margin-top:2.5rem;text-align:center;font-size:1.2rem"></div>
        </div>

        <!-- Shown only when logged out -->
        <div id="loggedOutHint" style="display:none;margin-top:2rem;text-align:center;color:var(--text-muted);font-size:0.95rem">
          Log in above to upload files or create pastes.
        </div>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2026 3nd3r.net
  </footer>

  <script>
    // ---------- Utilities ----------

    function formatBytes(bytes) {
      if (!bytes || bytes <= 0) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let i = 0;
      let value = bytes;
      while (value >= 1024 && i < units.length - 1) {
        value /= 1024;
        i++;
      }
      const fixed = value >= 10 || i === 0 ? value.toFixed(0) : value.toFixed(1);
      return fixed + ' ' + units[i];
    }

    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Truncate file titles for dashboard to max 10 chars (preserve short ext)
    function truncateFileTitle(name) {
      if (!name) return '';
      name = String(name);
      if (name.length <= 10) return name;

      const extIndex = name.lastIndexOf('.');
      if (extIndex > 0 && (name.length - extIndex) <= 5) {
        const ext = name.slice(extIndex);
        const maxBaseLen = Math.max(1, 10 - ext.length);
        return name.slice(0, maxBaseLen) + ext;
      }
      return name.slice(0, 10);
    }

    // ---------- Theme ----------

    const themeOrder = ['dark', 'light', 'terminal'];
    let themeTogglesInitialized = false;

    (function initThemeFromStorageOrSystem() {
      try {
        const storedTheme = localStorage.getItem('theme');
        const allowedThemes = ['dark', 'light', 'terminal'];
        if (allowedThemes.includes(storedTheme)) {
          document.documentElement.dataset.theme = storedTheme;
        } else {
          document.documentElement.dataset.theme =
            window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches
              ? 'light'
              : 'dark';
        }
      } catch (_) {
        document.documentElement.dataset.theme = 'dark';
      }
    })();

    function updateThemeButtons() {
      const root = document.documentElement;
      const current = root.dataset.theme || 'dark';
      const idx = themeOrder.indexOf(current);
      const next = themeOrder[(idx + 1) % themeOrder.length];

      let iconText, labelText;
      if (next === 'light') {
        iconText = 'Sun';
        labelText = 'Light';
      } else if (next === 'dark') {
        iconText = 'Moon';
        labelText = 'Dark';
      } else {
        iconText = '⌨︎';
        labelText = 'Terminal';
      }

      document.querySelectorAll('.theme-icon').forEach(el => el.textContent = iconText);
      document.querySelectorAll('.theme-label').forEach(el => el.textContent = labelText);
    }

    function setupThemeToggles() {
      if (themeTogglesInitialized) {
        updateThemeButtons();
        return;
      }
      themeTogglesInitialized = true;

      document.querySelectorAll('[data-theme-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
          const root = document.documentElement;
          const current = root.dataset.theme || 'dark';
          const idx = themeOrder.indexOf(current);
          const next = themeOrder[(idx + 1) % themeOrder.length];
          root.dataset.theme = next;
          try {
            localStorage.setItem('theme', next);
          } catch (_) {}
          updateThemeButtons();
        });
      });
      updateThemeButtons();
    }

    setupThemeToggles();

    // ---------- Routing ----------

    if (location.pathname === '/dashboard') {
      renderDashboard();
    } else if (location.pathname === '/admin') {
      renderAdmin();
    } else {
      initApp();
    }

    // ---------- Dashboard ----------

    function renderDashboard() {
      document.getElementById('app').style.display = 'none';
      document.getElementById('view').style.display = 'block';

      const vtitle = document.getElementById('vtitle');
      const vmeta  = document.getElementById('vmeta');
      const vcontent = document.getElementById('vcontent');

      vtitle.textContent = 'My Shares';
      vmeta.innerHTML = '';
      vcontent.innerHTML = `
        <div id="dashStats" style="margin-bottom:1rem;font-size:0.95rem;color:var(--text-muted);"></div>
        <div id="dashTableContainer" style="text-align:center;color:var(--text-muted)">Loading…</div>
      `;
      document.title = 'My Shares — Pastebin';

      const statsEl = document.getElementById('dashStats');
      const tableContainer = document.getElementById('dashTableContainer');

      fetch('/api/usage')
        .then(r => {
          if (r.status === 401) {
            tableContainer.innerHTML = '<div class="empty">You must be logged in to view your shares.</div>';
            throw new Error('unauth');
          }
          if (!r.ok) throw new Error('usage_failed');
          return r.json();
        })
        .then(stats => {
          const used = formatBytes(stats.usedBytes);
          const quota = formatBytes(stats.quotaBytes);
          const left = formatBytes(stats.remainingBytes);
          statsEl.textContent =
            `You have ${stats.fileCount} file${stats.fileCount === 1 ? '' : 's'}, using ${used} of ${quota} (${left} remaining).`;
          return fetch('/api/shares');
        })
        .then(r => {
          if (!r) return;
          if (r.status === 401) {
            tableContainer.innerHTML = '<div class="empty">You must be logged in to view your shares.</div>';
            return null;
          }
          if (!r.ok) throw new Error('shares_failed');
          return r.json();
        })
        .then(list => {
          if (!list) return;
          if (!list.length) {
            tableContainer.innerHTML = '<div class="empty">No shares yet — go make some magic!</div>';
            return;
          }

          tableContainer.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Type</th>
                  <th>Views</th>
                  <th>Size</th>
                  <th>Created</th>
                  <th>Expires</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${list.map(s => {
                  const type = s.type === 'paste' ? 'paste' : 'file';
                  const href = `/${type === 'paste' ? 'p' : 'f'}/${encodeURIComponent(s.id)}`;
                  const views = typeof s.views === 'number' ? s.views : 0;
                  const sizeLabel = type === 'file' ? formatBytes(s.size || 0) : '—';
                  let expiresLabel = '<span class="never">Never</span>';
                  if (s.expires) {
                    const ex = new Date(s.expires);
                    if (!isNaN(ex)) {
                      expiresLabel = escapeHtml(ex.toLocaleString());
                    }
                  }

                  const rawTitle = s.title || (type === 'file' ? 'file' : 'paste');
                  const displayTitle = type === 'file'
                    ? truncateFileTitle(rawTitle)
                    : rawTitle;

                  return `
                    <tr data-id="${escapeHtml(s.id)}" data-type="${type}">
                      <td>
                        <a href="${href}" target="_blank" rel="noopener">
                          ${escapeHtml(displayTitle)}
                        </a>
                      </td>
                      <td>${escapeHtml(type)}</td>
                      <td>${views}</td>
                      <td>${sizeLabel}</td>
                      <td>${escapeHtml(new Date(s.created).toLocaleString())}</td>
                      <td>${expiresLabel}</td>
                      <td>
                        <button class="btn btn-sm btn-outline dash-copy">Copy link</button>
                        <button class="btn btn-sm btn-danger dash-delete">Delete</button>
                      </td>
                    </tr>`;
                }).join('')}
              </tbody>
            </table>
          `;

          const rows = tableContainer.querySelectorAll('tbody tr');
          rows.forEach(row => {
            const id = row.getAttribute('data-id');
            const type = row.getAttribute('data-type');
            const href = `/${type === 'paste' ? 'p' : 'f'}/${id}`;
            const fullUrl = location.origin + href;

            const copyBtn = row.querySelector('.dash-copy');
            const delBtn  = row.querySelector('.dash-delete');

            if (copyBtn) {
              copyBtn.addEventListener('click', () => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(fullUrl)
                    .then(() => {
                      copyBtn.textContent = 'Copied!';
                      setTimeout(() => (copyBtn.textContent = 'Copy link'), 1200);
                    })
                    .catch(() => {
                      alert('Link: ' + fullUrl);
                    });
                } else {
                  alert('Link: ' + fullUrl);
                }
              });
            }

            if (delBtn) {
              delBtn.addEventListener('click', () => {
                if (!confirm('Delete this share? This cannot be undone.')) return;

                fetch(`/api/share/${type}/${id}`, { method: 'DELETE' })
                  .then(r => r.json())
                  .then(data => {
                    if (data && data.ok) {
                      row.remove();
                      if (!tableContainer.querySelector('tbody tr')) {
                        tableContainer.innerHTML = '<div class="empty">No shares left.</div>';
                        statsEl.textContent = '';
                      }
                    } else if (data && data.error) {
                      alert('Error deleting: ' + data.error);
                    } else {
                      alert('Error deleting share.');
                    }
                  })
                  .catch(() => {
                    alert('Error deleting share.');
                  });
              });
            }
          });
        })
        .catch(err => {
          if (err && err.message === 'unauth') return;
          console.error('Error loading dashboard:', err);
          tableContainer.innerHTML = '<div class="empty">Error loading shares.</div>';
        });

      setupThemeToggles();
    }

    // ---------- Admin Panel ----------

    function renderAdmin() {
      document.getElementById('app').style.display = 'none';
      document.getElementById('view').style.display = 'block';

      const vtitle = document.getElementById('vtitle');
      const vmeta  = document.getElementById('vmeta');
      const vcontent = document.getElementById('vcontent');

      vtitle.textContent = 'Admin Panel';
      vmeta.innerHTML = '';
      document.title = 'Admin — Pastebin';

      vcontent.innerHTML = `
        <div id="adminGuard" style="margin-bottom:1rem;color:var(--text-muted);"></div>
        <div id="adminContent" style="display:none;">
          <div style="display:grid;grid-template-columns:1.1fr 1.1fr;gap:1.5rem;flex-wrap:wrap;">
            <section style="border:1px solid var(--border);border-radius:1rem;padding:1rem;">
              <h2 style="margin-bottom:0.8rem;font-size:1.05rem;">Stats</h2>
              <div id="adminStats">Loading…</div>
            </section>

            <section style="border:1px solid var(--border);border-radius:1rem;padding:1rem;">
              <h2 style="margin-bottom:0.8rem;font-size:1.05rem;">Share Lookup</h2>
              <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.8rem;">
                <input id="adminShareId" placeholder="Share ID (file or paste)" style="flex:1;padding:0.4rem 0.6rem;border-radius:0.6rem;border:1px solid var(--border);background:var(--bg-soft);color:var(--text-primary);">
                <button id="adminShareSearchBtn" class="btn btn-sm">Search</button>
              </div>
              <div id="adminShareResult" style="font-size:0.9rem;color:var(--text-muted);"></div>
            </section>
          </div>

          <section style="border:1px solid var(--border);border-radius:1rem;padding:1rem;margin-top:1.5rem;">
            <h2 style="margin-bottom:0.8rem;font-size:1.05rem;">User Search</h2>
            <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.6rem;flex-wrap:wrap;">
              <input id="adminUserQuery" placeholder="Search by email" style="flex:1;min-width:180px;padding:0.4rem 0.6rem;border-radius:0.6rem;border:1px solid var(--border);background:var(--bg-soft);color:var(--text-primary);">
              <button id="adminUserSearchBtn" class="btn btn-sm">Search</button>
            </div>
            <div id="adminUserResults" style="max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:0.8rem;padding:0.5rem;font-size:0.9rem;"></div>
            <div id="adminUserDetail" style="margin-top:1rem;font-size:0.9rem;"></div>
          </section>

          <section style="border:1px solid var(--border);border-radius:1rem;padding:1rem;margin-top:1.5rem;">
            <h2 style="margin-bottom:0.8rem;font-size:1.05rem;">Blocked IPs</h2>
            <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.8rem;flex-wrap:wrap;">
              <input id="adminIpInput" placeholder="IP to block" style="flex:1;min-width:150px;padding:0.4rem 0.6rem;border-radius:0.6rem;border:1px solid var(--border);background:var(--bg-soft);color:var(--text-primary);">
              <input id="adminIpReason" placeholder="Reason (optional)" style="flex:2;min-width:180px;padding:0.4rem 0.6rem;border-radius:0.6rem;border:1px solid var(--border);background:var(--bg-soft);color:var(--text-primary);">
              <button id="adminAddIpBtn" class="btn btn-sm">Block IP</button>
            </div>
            <div id="adminIpList" style="max-height:220px;overflow:auto;font-size:0.9rem;border:1px solid var(--border);border-radius:0.8rem;padding:0.5rem;"></div>
          </section>
        </div>
      `;

      const guardEl = document.getElementById('adminGuard');
      const adminContent = document.getElementById('adminContent');

      fetch('/api/me')
        .then(r => {
          if (!r.ok) throw new Error('me_failed');
          return r.json();
        })
        .then(me => {
          if (!me.loggedIn || !me.isAdmin) {
            guardEl.textContent = 'Admin only. Log in as an administrator to access this panel.';
            adminContent.style.display = 'none';
            return;
          }
          guardEl.textContent = 'Signed in as ' + (me.email || '') + ' — Admin';
          adminContent.style.display = 'block';
          setupAdminHandlers();
          loadAdminStats();
          loadBlockedIps();
        })
        .catch(err => {
          console.error('Error verifying admin:', err);
          guardEl.textContent = 'Error verifying admin.';
          adminContent.style.display = 'none';
        });

      setupThemeToggles();
    }

    function setupAdminHandlers() {
      const statsEl = document.getElementById('adminStats');
      const userQuery = document.getElementById('adminUserQuery');
      const userSearchBtn = document.getElementById('adminUserSearchBtn');
      const userResultsEl = document.getElementById('adminUserResults');
      const userDetailEl = document.getElementById('adminUserDetail');

      const shareIdInput = document.getElementById('adminShareId');
      const shareSearchBtn = document.getElementById('adminShareSearchBtn');
      const shareResultEl = document.getElementById('adminShareResult');

      const ipInput = document.getElementById('adminIpInput');
      const ipReason = document.getElementById('adminIpReason');
      const addIpBtn = document.getElementById('adminAddIpBtn');
      const ipList = document.getElementById('adminIpList');

      // User search
      function doUserSearch() {
        const q = userQuery.value.trim();
        if (!q) {
          userResultsEl.innerHTML = '<div style="color:var(--text-muted);">Enter an email fragment to search.</div>';
          userDetailEl.innerHTML = '';
          return;
        }
        userResultsEl.textContent = 'Searching…';
        userDetailEl.innerHTML = '';

        fetch('/api/admin/users?q=' + encodeURIComponent(q))
          .then(r => r.json())
          .then(list => {
            if (!Array.isArray(list) || !list.length) {
              userResultsEl.innerHTML = '<div style="color:var(--text-muted);">No users found.</div>';
              return;
            }

            userResultsEl.innerHTML = `
              <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                <thead>
                  <tr>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">ID</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Email</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Role</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Banned</th>
                  </tr>
                </thead>
                <tbody>
                  ${list.map(u => {
                    const pillClass =
                      u.is_banned ? 'pill pill-banned' :
                      (u.role === 'admin' ? 'pill pill-admin' :
                       (u.role === 'mod' ? 'pill pill-mod' : 'pill'));
                    const bannedText = u.is_banned ? 'Yes' : 'No';
                    return `
                      <tr data-user-id="${u.id}" class="admin-user-row" style="cursor:pointer;">
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">${u.id}</td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">${escapeHtml(u.email)}</td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">
                          <span class="${pillClass}">${escapeHtml(u.role || 'user')}</span>
                        </td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">${bannedText}</td>
                      </tr>`;
                  }).join('')}
                </tbody>
              </table>
            `;

            userResultsEl.querySelectorAll('.admin-user-row').forEach(row => {
              row.addEventListener('click', () => {
                const userId = row.getAttribute('data-user-id');
                showUserDetail(userId);
              });
            });
          })
          .catch(err => {
            console.error('Admin user search error:', err);
            userResultsEl.innerHTML = '<div style="color:var(--danger);">Error searching users.</div>';
          });
      }

      userSearchBtn.addEventListener('click', doUserSearch);
      userQuery.addEventListener('keydown', e => { if (e.key === 'Enter') doUserSearch(); });

      function showUserDetail(userId) {
        userDetailEl.innerHTML = 'Loading user detail…';

        Promise.all([
          fetch('/api/admin/user/' + encodeURIComponent(userId) + '/shares').then(r => r.json()),
          fetch('/api/admin/users?q=' + encodeURIComponent(userId)).then(r => r.json()).catch(() => [])
        ]).then(([shares, userList]) => {
          const user = Array.isArray(userList)
            ? userList.find(u => String(u.id) === String(userId))
            : null;

          const role = user ? (user.role || 'user') : 'user';
          const banned = user ? !!user.is_banned : false;

          let html = '';
          html += `<div style="margin-bottom:0.6rem;"><strong>User ID:</strong> ${escapeHtml(userId)}</div>`;
          if (user) {
            html += `<div style="margin-bottom:0.6rem;"><strong>Email:</strong> ${escapeHtml(user.email)}</div>`;
            html += `<div style="margin-bottom:0.6rem;"><strong>Role:</strong> ${escapeHtml(role)}</div>`;
            html += `<div style="margin-bottom:0.6rem;"><strong>Banned:</strong> ${banned ? 'Yes' : 'No'}</div>`;
          }

          html += `
            <div style="margin-bottom:0.8rem;">
              <label style="font-size:0.85rem;margin-right:0.4rem;">Set role:</label>
              <select id="adminRoleSelect" style="padding:0.2rem 0.4rem;border-radius:0.4rem;border:1px solid var(--border);background:var(--bg-soft);color:var(--text-primary);">
                <option value="user"${role === 'user' ? ' selected' : ''}>user</option>
                <option value="mod"${role === 'mod' ? ' selected' : ''}>mod</option>
                <option value="admin"${role === 'admin' ? ' selected' : ''}>admin</option>
              </select>
              <button id="adminRoleSaveBtn" class="btn btn-sm" style="margin-left:0.4rem;">Save</button>
            </div>
            <div style="margin-bottom:0.8rem;">
              <button id="adminBanToggleBtn" class="btn btn-sm ${banned ? 'btn-success' : 'btn-danger'}">
                ${banned ? 'Unban user' : 'Ban user'}
              </button>
            </div>
          `;

          if (Array.isArray(shares) && shares.length) {
            html += `<div style="margin-top:0.8rem;"><strong>Shares:</strong></div>`;
            html += `
              <table style="width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:0.3rem;">
                <thead>
                  <tr>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">ID</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Type</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Title</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Views</th>
                    <th style="border-bottom:1px solid var(--border);padding:0.3rem;text-align:left;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${shares.map(s => {
                    const type = s.type === 'paste' ? 'paste' : 'file';
                    const href = `/${type === 'paste' ? 'p' : 'f'}/${encodeURIComponent(s.id)}`;
                    const title = s.title || (type === 'file' ? 'file' : 'paste');
                    return `
                      <tr data-share-id="${s.id}" data-share-type="${type}">
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">${escapeHtml(s.id)}</td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">${type}</td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">
                          <a href="${href}" target="_blank" rel="noopener">${escapeHtml(title)}</a>
                        </td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">${s.views || 0}</td>
                        <td style="padding:0.3rem;border-bottom:1px solid var(--border);">
                          <button class="btn btn-sm btn-danger admin-delete-share-btn">Delete</button>
                        </td>
                      </tr>`;
                  }).join('')}
                </tbody>
              </table>
            `;
          } else {
            html += '<div style="margin-top:0.6rem;color:var(--text-muted);">No shares for this user.</div>';
          }

          userDetailEl.innerHTML = html;

          const roleSelect = document.getElementById('adminRoleSelect');
          const roleSaveBtn = document.getElementById('adminRoleSaveBtn');
          const banToggleBtn = document.getElementById('adminBanToggleBtn');

          if (roleSaveBtn) {
            roleSaveBtn.addEventListener('click', () => {
              const newRole = roleSelect.value;
              fetch('/api/admin/user/role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, role: newRole })
              }).then(r => r.json())
                .then(data => {
                  if (data && data.ok) {
                    alert('Role updated.');
                    doUserSearch();
                  } else {
                    alert('Error updating role: ' + (data && data.error || 'unknown'));
                  }
                })
                .catch(err => {
                  console.error('Role update error:', err);
                  alert('Error updating role.');
                });
            });
          }

          if (banToggleBtn) {
            banToggleBtn.addEventListener('click', () => {
              const newBanned = !banned;
              if (newBanned && !confirm('Ban this user? This will also block their future logins.')) return;

              fetch('/api/admin/user/ban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, banned: newBanned })
              }).then(r => r.json())
                .then(data => {
                  if (data && data.ok) {
                    alert(newBanned ? 'User banned.' : 'User unbanned.');
                    doUserSearch();
                    showUserDetail(userId);
                  } else {
                    alert('Error updating ban status: ' + (data && data.error || 'unknown'));
                  }
                })
                .catch(err => {
                  console.error('Ban update error:', err);
                  alert('Error updating ban status.');
                });
            });
          }

          userDetailEl.querySelectorAll('.admin-delete-share-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const row = btn.closest('tr');
              const shareId = row.getAttribute('data-share-id');
              const shareType = row.getAttribute('data-share-type');
              if (!confirm(`Delete this ${shareType} share ${shareId}? This cannot be undone.`)) return;

              fetch(`/api/share/${shareType}/${shareId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                  if (data && data.ok) {
                    alert('Share deleted.');
                    row.remove();
                  } else {
                    alert('Error deleting share: ' + (data && data.error || 'unknown'));
                  }
                })
                .catch(err => {
                  console.error('Admin delete share error:', err);
                  alert('Error deleting share.');
                });
            });
          });
        }).catch(err => {
          console.error('Admin user detail error:', err);
          userDetailEl.innerHTML = '<div style="color:var(--danger);">Error loading user detail.</div>';
        });
      }

      // Share search
      function doShareSearch() {
        const id = shareIdInput.value.trim();
        if (!id) {
          shareResultEl.textContent = 'Enter a share ID.';
          return;
        }
        shareResultEl.textContent = 'Searching…';

        fetch('/api/admin/share/' + encodeURIComponent(id))
          .then(r => r.json())
          .then(data => {
            if (data && data.error) {
              shareResultEl.textContent = 'Not found.';
              return;
            }
            const type = data.type;
            const s = data.share;
            const href = `/${type === 'paste' ? 'p' : 'f'}/${encodeURIComponent(s.id)}`;
            const info = [
              `<strong>Type:</strong> ${escapeHtml(type)}`,
              `<strong>ID:</strong> ${escapeHtml(s.id)}`,
              `<strong>User ID:</strong> ${escapeHtml(String(s.user_id))}`,
              `<strong>Created:</strong> ${new Date(s.created).toLocaleString()}`,
              `<strong>Views:</strong> ${s.views || 0}`,
            ];
            if (type === 'file') {
              info.push(`<strong>Size:</strong> ${formatBytes(s.size || 0)}`);
              info.push(`<strong>MIME:</strong> ${escapeHtml(s.mime || '')}`);
            }
            shareResultEl.innerHTML = `
              <div style="margin-bottom:0.6rem;">
                ${info.join('<br>')}
              </div>
              <div style="margin-bottom:0.6rem;">
                <a href="${href}" target="_blank" rel="noopener">Open</a>
              </div>
              <button id="adminDeleteShareDirectBtn" class="btn btn-sm btn-danger">Delete share</button>
            `;

            const delBtn = document.getElementById('adminDeleteShareDirectBtn');
            delBtn.addEventListener('click', () => {
              if (!confirm(`Delete this ${type} share ${s.id}? This cannot be undone.`)) return;
              fetch(`/api/share/${type}/${s.id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(resp => {
                  if (resp && resp.ok) {
                    alert('Share deleted.');
                    shareResultEl.textContent = 'Share deleted.';
                  } else {
                    alert('Error deleting: ' + (resp && resp.error || 'unknown'));
                  }
                })
                .catch(err => {
                  console.error('Admin direct delete error:', err);
                  alert('Error deleting share.');
                });
            });
          })
          .catch(err => {
            console.error('Admin share lookup error:', err);
            shareResultEl.textContent = 'Error looking up share.';
          });
      }

      shareSearchBtn.addEventListener('click', doShareSearch);
      shareIdInput.addEventListener('keydown', e => { if (e.key === 'Enter') doShareSearch(); });

      // IP block list
      addIpBtn.addEventListener('click', () => {
        const ip = ipInput.value.trim();
        const reason = ipReason.value.trim();
        if (!ip) {
          alert('IP is required.');
          return;
        }
        fetch('/api/admin/blocked-ips', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip, reason })
        }).then(r => r.json())
          .then(data => {
            if (data && data.ok) {
              ipInput.value = '';
              ipReason.value = '';
              loadBlockedIps();
            } else {
              alert('Error blocking IP: ' + (data && data.error || 'unknown'));
            }
          })
          .catch(err => {
            console.error('Admin block IP error:', err);
            alert('Error blocking IP.');
          });
      });

      function loadBlockedIps() {
        ipList.textContent = 'Loading…';
        fetch('/api/admin/blocked-ips')
          .then(r => r.json())
          .then(list => {
            if (!Array.isArray(list) || !list.length) {
              ipList.innerHTML = '<div style="color:var(--text-muted);">No blocked IPs.</div>';
              return;
            }
            ipList.innerHTML = list.map(row => {
              const created = new Date(row.created).toLocaleString();
              const reason = row.reason ? escapeHtml(row.reason) : '(no reason)';
              return `
                <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:0.25rem 0;">
                  <div>
                    <div><strong>${escapeHtml(row.ip)}</strong></div>
                    <div style="font-size:0.8rem;color:var(--text-muted);">${reason} — ${created}</div>
                  </div>
                  <button class="btn btn-sm btn-danger admin-unblock-ip-btn" data-ip="${escapeHtml(row.ip)}">Unblock</button>
                </div>
              `;
            }).join('');

            ipList.querySelectorAll('.admin-unblock-ip-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const ip = btn.getAttribute('data-ip');
                if (!confirm('Unblock ' + ip + '?')) return;
                fetch('/api/admin/blocked-ips/' + encodeURIComponent(ip), {
                  method: 'DELETE'
                }).then(r => r.json())
                  .then(data => {
                    if (data && data.ok) {
                      loadBlockedIps();
                    } else {
                      alert('Error unblocking IP: ' + (data && data.error || 'unknown'));
                    }
                  })
                  .catch(err => {
                    console.error('Admin unblock IP error:', err);
                    alert('Error unblocking IP.');
                  });
              });
            });
          })
          .catch(err => {
            console.error('Admin blocked IPs error:', err);
            ipList.innerHTML = '<div style="color:var(--danger);">Error loading blocked IPs.</div>';
          });
      }

      window.loadBlockedIps = loadBlockedIps;

      function loadAdminStats() {
        statsEl.textContent = 'Loading…';
        fetch('/api/admin/stats')
          .then(r => r.json())
          .then(stats => {
            if (!stats || stats.error) {
              statsEl.textContent = 'Error loading stats.';
              return;
            }
            const totalSize = formatBytes(stats.totalFilesSize || 0);
            statsEl.innerHTML = `
              <div><strong>Total users:</strong> ${stats.totalUsers}</div>
              <div><strong>Total files:</strong> ${stats.totalFiles} (${totalSize})</div>
              <div><strong>Total pastes:</strong> ${stats.totalPastes}</div>
              <div><strong>Blocked IPs:</strong> ${stats.blockedIps}</div>
            `;
          })
          .catch(err => {
            console.error('Admin stats error:', err);
            statsEl.textContent = 'Error loading stats.';
          });
      }

      window.loadAdminStats = loadAdminStats;
    }

    function loadAdminStats() {}
    function loadBlockedIps() {}

    // ---------- Main App ----------

    function initApp() {
      document.getElementById('app').style.display = 'block';
      document.getElementById('view').style.display = 'none';
      document.title = 'Pastebin';

      const authStatusEl = document.getElementById('authStatus');
      const loggedOutView = document.getElementById('loggedOutView');
      const loggedInView = document.getElementById('loggedInView');
      const userLabel = document.getElementById('userLabel');
      const mainContent = document.getElementById('mainContent');
      const loggedOutHint = document.getElementById('loggedOutHint');
      const adminBtn = document.getElementById('openAdmin');

      function setLoggedIn(me) {
        loggedOutView.style.display = 'none';
        loggedInView.style.display = 'flex';
        userLabel.textContent = me.email;
        mainContent.style.display = 'block';
        loggedOutHint.style.display = 'none';
        authStatusEl.textContent = '';
        authStatusEl.className = 'auth-status';
        if (me.isAdmin) {
          adminBtn.style.display = 'inline-flex';
        } else {
          adminBtn.style.display = 'none';
        }
      }

      function setLoggedOut() {
        loggedOutView.style.display = 'block';
        loggedInView.style.display = 'none';
        mainContent.style.display = 'none';
        loggedOutHint.style.display = 'block';
        authStatusEl.textContent = '';
        authStatusEl.className = 'auth-status';
        adminBtn.style.display = 'none';
      }

      fetch('/api/me')
        .then(r => {
          if (!r.ok) throw new Error('me_failed');
          return r.json();
        })
        .then(me => {
          if (me.loggedIn) {
            setLoggedIn(me);
          } else {
            setLoggedOut();
          }
        })
        .catch(err => {
          console.error('Error fetching /api/me:', err);
          setLoggedOut();
        });

      document.getElementById('loginBtn').addEventListener('click', () => {
        const emailInput = document.getElementById('authEmail');
        const passwordInput = document.getElementById('authPassword');
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        if (!email || !password) {
          authStatusEl.textContent = 'Email and password are required.';
          authStatusEl.className = 'auth-status error';
          return;
        }

        authStatusEl.textContent = 'Logging in…';
        authStatusEl.className = 'auth-status';

        fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        })
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              authStatusEl.textContent = data.error;
              authStatusEl.className = 'auth-status error';
              return;
            }
            authStatusEl.textContent = 'Logged in!';
            authStatusEl.className = 'auth-status ok';
            fetch('/api/me')
              .then(r => r.json())
              .then(me => {
                setLoggedIn(me);
              });
            passwordInput.value = '';
            passwordInput.blur();
          })
          .catch(err => {
            console.error('Error logging in:', err);
            authStatusEl.textContent = 'Error logging in.';
            authStatusEl.className = 'auth-status error';
          });
      });

      document.getElementById('registerBtn').addEventListener('click', () => {
        const emailInput = document.getElementById('authEmail');
        const passwordInput = document.getElementById('authPassword');
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        if (!email || !password) {
          authStatusEl.textContent = 'Email and password are required.';
          authStatusEl.className = 'auth-status error';
          return;
        }
        if (password.length < 6) {
          authStatusEl.textContent = 'Password must be at least 6 characters.';
          authStatusEl.className = 'auth-status error';
          return;
        }

        authStatusEl.textContent = 'Creating account…';
        authStatusEl.className = 'auth-status';

        fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        })
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              authStatusEl.textContent = data.error;
              authStatusEl.className = 'auth-status error';
              return;
            }
            authStatusEl.textContent = 'Account created & logged in!';
            authStatusEl.className = 'auth-status ok';
            fetch('/api/me')
              .then(r => r.json())
              .then(me => {
                setLoggedIn(me);
              });
            passwordInput.value = '';
            passwordInput.blur();
          })
          .catch(err => {
            console.error('Error creating account:', err);
            authStatusEl.textContent = 'Error creating account.';
            authStatusEl.className = 'auth-status error';
          });
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        fetch('/api/logout', { method: 'POST' })
          .then(() => {
            setLoggedOut();
          })
          .catch(err => {
            console.error('Error logging out:', err);
            setLoggedOut();
          });
      });

      document.getElementById('openDashboard').addEventListener('click', () => {
        location.href = '/dashboard';
      });

      document.getElementById('openAdmin').addEventListener('click', () => {
        location.href = '/admin';
      });

      const setMode = m => {
        const filesBtn = document.getElementById('modeFilesBtn');
        const pasteBtn = document.getElementById('modePasteBtn');
        if (!filesBtn || !pasteBtn) return;

        filesBtn.classList.toggle('active', m === 'files');
        pasteBtn.classList.toggle('active', m === 'paste');

        document.getElementById('fileDropzone').style.display =
          m === 'files' ? 'block' : 'none';
        document.getElementById('pasteContainer').style.display =
          m === 'paste' ? 'block' : 'none';

        try {
          localStorage.setItem('mode', m);
        } catch (_) {}
      };

      document.getElementById('modeFilesBtn').addEventListener('click', () => setMode('files'));
      document.getElementById('modePasteBtn').addEventListener('click', () => setMode('paste'));

      let initialMode = 'files';
      try {
        const storedMode = localStorage.getItem('mode');
        if (storedMode === 'paste' || storedMode === 'files') {
          initialMode = storedMode;
        }
      } catch (_) {}
      setMode(initialMode);

      document.querySelectorAll('.expiry-btn').forEach(b => {
        b.addEventListener('click', () => {
          document.querySelectorAll('.expiry-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
        });
      });

      const getExpiry = () => {
        const active = document.querySelector('.expiry-btn.active');
        if (!active) return null;
        const v = active.dataset.expiry;
        return v === 'never' ? null : v;
      };

      const fileInput = document.getElementById('fileInput');
      const dropzone  = document.getElementById('fileDropzone');
      const statusEl  = document.getElementById('status');

      document.getElementById('browseBtn').addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', e => handleFiles(e.target.files));

      function handleFiles(files) {
        if (!files || !files.length) return;

        const expiry = getExpiry();
        statusEl.textContent = 'Uploading…';

        const uploads = Array.from(files).map(file => {
          const fd = new FormData();
          fd.append('file', file);
          if (expiry) fd.append('expiry', expiry);

          return fetch('/upload', {
            method: 'POST',
            body: fd
          })
            .then(r => {
              if (r.status === 401) {
                return { _unauth: true };
              }
              if (!r.ok) {
                return { _error: true };
              }
              return r.json();
            })
            .catch(err => {
              console.error('Upload error:', err);
              return { _error: true };
            });
        });

        Promise.all(uploads).then(results => {
          if (results.some(r => r && r._unauth)) {
            statusEl.textContent = 'You must be logged in to upload.';
            return;
          }

          const success = results.filter(r => r && !r._unauth && !r._error && !r.error && r.url);
          if (!success.length) {
            console.error('Upload responses:', results);
            statusEl.textContent = 'Upload failed.';
            return;
          }

          const countLabel = success.length > 1 ? `${success.length} files` : '1 file';

          statusEl.textContent = '';
          const header = document.createElement('div');
          header.textContent = `Uploaded ${countLabel}!`;
          statusEl.appendChild(header);

          success.forEach((r, idx) => {
            const url = r.url;
            const line = document.createElement('div');
            if (success.length > 1) {
              const prefix = document.createTextNode(`${idx + 1}. `);
              line.appendChild(prefix);
            }
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.style.fontSize = '1.1rem';
            link.style.fontWeight = '600';
            link.textContent = url;
            line.appendChild(link);
            statusEl.appendChild(line);
          });
        });
      }

      ['dragenter', 'dragover'].forEach(evt => {
        dropzone.addEventListener(evt, e => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.style.borderColor = 'var(--accent)';
        });
      });

      ['dragleave', 'dragend', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, e => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.style.borderColor = 'var(--border)';
        });
      });

      dropzone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        handleFiles(files);
      });

      dropzone.addEventListener('click', () => fileInput.click());

      document.getElementById('pasteSubmitBtn').addEventListener('click', () => {
        const pasteInput = document.getElementById('pasteInput');
        const text = pasteInput.value.trim();
        if (!text) return;

        statusEl.textContent = 'Saving…';

        const expiry = getExpiry();
        let url = '/paste';
        if (expiry) {
          const params = new URLSearchParams({ expiry });
          url += '?' + params.toString();
        }

        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: text
        })
          .then(r => {
            if (r.status === 401) {
              statusEl.textContent = 'You must be logged in to save pastes.';
              return null;
            }
            if (!r.ok) {
              throw new Error('paste_failed');
            }
            return r.json();
          })
          .then(data => {
            if (!data) return;
            if (data.error) {
              statusEl.textContent = 'Error: ' + data.error;
              return;
            }
            const pasteUrl = data.url;
            let expiryLabel = '';
            if (expiry) {
              const map = {
                '1h': ' (expires in 1 hour)',
                '1d': ' (expires in 1 day)',
                '7d': ' (expires in 7 days)',
                '30d': ' (expires in 30 days)'
              };
              expiryLabel = map[expiry] || '';
            }

            statusEl.textContent = '';
            const line1 = document.createElement('div');
            line1.textContent = `Paste ready${expiryLabel}!`;
            statusEl.appendChild(line1);

            const link = document.createElement('a');
            link.href = pasteUrl;
            link.target = '_blank';
            link.rel = 'noopener';
            link.style.fontSize = '1.4rem';
            link.style.fontWeight = '600';
            link.textContent = pasteUrl;
            statusEl.appendChild(link);

            pasteInput.value = '';
          })
          .catch(err => {
            console.error('Error saving paste:', err);
            statusEl.textContent = 'Error saving paste.';
          });
      });

      setupThemeToggles();
    }
  </script>
</body>
</html>
